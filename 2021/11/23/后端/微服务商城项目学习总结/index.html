<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>微服务商城项目学习总结 | 哀殿firstの空间</title><meta name="author" content="aidianfirst"><meta name="copyright" content="aidianfirst"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="虚拟机环境配置这次使用Virtual Box + Vagrant完成虚拟机安装，比传统VMware配置镜像更方便，Vagrant可下载打包好的镜像文件进行安装，无需详细配置。 https:&amp;#x2F;&amp;#x2F;blog.csdn.net&amp;#x2F;qq_15990969&amp;#x2F;article&amp;#x2F;details&amp;#x2F;113096469 ht"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/aidianfirst/image/icon.png"><link rel="canonical" href="http://aidianfirst.com/2021/11/23/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '微服务商城项目学习总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-30 19:20:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="哀殿firstの空间" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/aidianfirst/image/aidian.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/aidianfirst/image/aidian6.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="哀殿firstの空间"><span class="site-name">哀殿firstの空间</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">微服务商城项目学习总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-11-23T09:29:08.000Z" title="发表于 2021-11-23 17:29:08">2021-11-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-07-30T11:20:17.736Z" title="更新于 2023-07-30 19:20:17">2023-07-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="微服务商城项目学习总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="虚拟机环境配置"><a href="#虚拟机环境配置" class="headerlink" title="虚拟机环境配置"></a>虚拟机环境配置</h1><p>这次使用Virtual Box + Vagrant完成虚拟机安装，比传统VMware配置镜像更方便，Vagrant可下载打包好的镜像文件进行安装，无需详细配置。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_15990969/article/details/113096469">https://blog.csdn.net/qq_15990969/article/details/113096469</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lxwphp/p/11121283.html">https://www.cnblogs.com/lxwphp/p/11121283.html</a></p>
<h1 id="快速反向工程辅助crud"><a href="#快速反向工程辅助crud" class="headerlink" title="快速反向工程辅助crud"></a>快速反向工程辅助crud</h1><p>使用renren脚手架辅助开发，对应前后端分离，renren-fast，renren-fast-vue，renren-generator使用前需删除.git文件，这是官方的git信息</p>
<p>renren的service层无需注入dao，它继承了一个父类，父类注入了baseMapper，而这个baseMapper的类型是对应继承时类的泛型M的，人人继承这个父类就会用自己的dao实现泛型，所以此时父类注入的baseMapper即我们需要的dao，封装nb。</p>
<h1 id="商品服务"><a href="#商品服务" class="headerlink" title="商品服务"></a>商品服务</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/unique_perfect/article/details/113824202">https://blog.csdn.net/unique_perfect/article/details/113824202</a></p>
<p>可以拿sql数据，1000+商品词条。</p>
<h2 id="菜单分级展示"><a href="#菜单分级展示" class="headerlink" title="菜单分级展示"></a>菜单分级展示</h2><p>先查一级菜单，然后递归查询二级菜单，给product商品加上子菜单，方便设置，数据库没有该字段需注明exist。</p>
<h2 id="网关（跨域）"><a href="#网关（跨域）" class="headerlink" title="网关（跨域）"></a>网关（跨域）</h2><p>通过gateway路由请求，涉及<strong>跨域问题</strong>（同源策略）。</p>
<p>非简单请求先发送预检请求option，服务器不允许则不发送请求。</p>
<p>我们在gateway的微服务中进行config配置，使用前置filter过滤请求即可，放行所有的请求都跨域。CorsWebFilter是官方提供跨域过滤器。</p>
<p><strong>端口号的动态刷新，好像能取改变后的值，但访问的url没变？</strong></p>
<h2 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h2><p><strong>我们删除使用逻辑删除</strong>，即属性有个字段为是否展示，我们提供改变这个字段状态将属性隐藏显示，而不是将数据真正的删除。</p>
<p>mybatis-plus自带逻辑删除组件配置，yml配置</p>
<h2 id="JSR303"><a href="#JSR303" class="headerlink" title="JSR303"></a>JSR303</h2><p>品牌管理进行后端校验，仅仅前端校验是不够的，以防越过前端直接访问接口。</p>
<p>@NotBlank等注解标明字段，@Valid标明业务实体类参数，随后进行校验，@NotBlank可自定义message，校验失败返回对应信息。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可写一个统一的异常处理类，使用@ControllerAdvice</p>
<p>JSR303还可进行分组校验。使用象征性接口进行标识。</p>
<h2 id="属性分组"><a href="#属性分组" class="headerlink" title="属性分组"></a>属性分组</h2><p>SPU相当于一个抽象概念，如米8手机。</p>
<p>SKU是具体概念，也就是米8手机的具体配置，配置不同价值也不同。</p>
<p>数据库基于这个概念进行分类，如米8 128g，只有黑色、白色内存大小8g，米8 256g，有黑白蓝绿等颜色，内存大小16g，不同的SKU具体实现的内容不同。</p>
<h2 id="关联分类"><a href="#关联分类" class="headerlink" title="关联分类"></a>关联分类</h2><p>品牌管理可将品牌和分类的关系存到一张表记录，我们修改品牌与分类名时，要联动修改这个表的数据。</p>
<h2 id="VO"><a href="#VO" class="headerlink" title="VO"></a>VO</h2><p>view object，我们实体类一般用于数据库操作，有时引入其他字段还需要注解标明字段不属于数据库，所以我们可以多进行一层封装，继承实体类，添加用于视图返回的字段。</p>
<p>我们可以根据应用场景的不同，对原实体类继承后二次封装，防止实体类注解冗余。</p>
<h2 id="生成商品Vo"><a href="#生成商品Vo" class="headerlink" title="生成商品Vo"></a>生成商品Vo</h2><p>先创建json数据，然后使用工具反向生成vo，导入vo然后用这个实体去进行保存。为了保证精度，小数操作值使用BigDecimal，id使用long。</p>
<h2 id="Transactional"><a href="#Transactional" class="headerlink" title="@Transactional"></a>@Transactional</h2><p>对商品进行添加时，会影响多个表，所以我们使用事务进行控制</p>
<h2 id="feign服务调用"><a href="#feign服务调用" class="headerlink" title="feign服务调用"></a>feign服务调用</h2><p>spu需要记录优惠信息，调用其他服务的接口，使用TO传输，跨服务传输，可在常用服务组件中封装TO。</p>
<p>服务调用时，feign接口调用参数需要和服务一致？？？参数需要<code>@RequestBody</code>注解，转为json传输（如果传的是对象实例），可以和服务端实例不同，只要两个转换的json能相互转换即可。但是为了方便我们还是使用同一个传输对象作为保准比较好对应。</p>
<p>但这里我们调用远端服务使用的是逆向工程直接创建的方法，参数不好改，也可以直接使用实体类，因为json可以互转。</p>
<h2 id="商品详情"><a href="#商品详情" class="headerlink" title="商品详情"></a>商品详情</h2><p>采用CompletableFuture异步编排进行优化，商品信息是逐个查询的，采用异步编排，自定义线程池，对商品查询进行多线程任务，加快信息的查询速度。</p>
<h1 id="阿里云第三方服务"><a href="#阿里云第三方服务" class="headerlink" title="阿里云第三方服务"></a>阿里云第三方服务</h1><h2 id="第三方服务云存储OSS"><a href="#第三方服务云存储OSS" class="headerlink" title="第三方服务云存储OSS"></a>第三方服务云存储OSS</h2><p>由于微服务负载均衡，图片等本地存储资源不能存放于服务器，否则其他服务器找不到服务。我们跨域统一存放这类资源到云服务器上，进行统一的调用。阿里云OSS</p>
<p>文件上传，<strong>使用服务端签名后直传</strong>，借助阿里云封装的sdk完成上传</p>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/32009.html">https://help.aliyun.com/document_detail/32009.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/aliyun-spring-boot/tree/master/aliyun-spring-boot-samples/aliyun-oss-spring-boot-sample">https://github.com/alibaba/aliyun-spring-boot/tree/master/aliyun-spring-boot-samples/aliyun-oss-spring-boot-sample</a></p>
<p>官方依赖有坑，yml也坑，这里建议比对网络博客</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alicloud-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment"># 阿里云服务配置</span></span><br><span class="line">    <span class="attr">alicloud:</span></span><br><span class="line">      <span class="attr">access-key:</span> </span><br><span class="line">      <span class="attr">secret-key:</span> </span><br><span class="line">      <span class="attr">oss:</span> </span><br><span class="line">        <span class="attr">endpoint:</span> <span class="string">oss-cn-shanghai.aliyuncs.com</span></span><br></pre></td></tr></table></figure>

<h2 id="短信验证码"><a href="#短信验证码" class="headerlink" title="短信验证码"></a>短信验证码</h2><p>去阿里云随便找一家短信服务提供商免费测试即可，0元20次套餐够用了，看官方的接口文档进行参数配置。</p>
<p>调用官方封装的java类，自定义传参即可。还可抽取配置文件，将路径、api等信息再配置文件中进行配置，使用@ConfigurationProperties注解自定义配置文件属性。</p>
<ul>
<li>接口防刷</li>
<li>验证码多次校验</li>
</ul>
<h1 id="Elasticsearch（7-6-2）"><a href="#Elasticsearch（7-6-2）" class="headerlink" title="Elasticsearch（7.6.2）"></a>Elasticsearch（7.6.2）</h1><p>索引、文档、倒排索引、分词匹配。</p>
<p>elasticsearch + kibana，分词器ik-analyzer。</p>
<p>我们项目使用es使用9200端口，9300相关连接方法已舍弃，只支持6.x。可通过Elasticsearch-Rest-Client，跟进新版本迭代，支持7.x。</p>
<p>官方：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.6/java-rest-high.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.6/java-rest-high.html</a></p>
<h2 id="商品上架"><a href="#商品上架" class="headerlink" title="商品上架"></a>商品上架</h2><p>ES只检索上架的商品，上架商品改变状态，并存放到ES，只选择存储关键信息，如商品标题字段就是关键，还要配置分词器，其他的一些展示字段如图片等则不参与聚合操作，只是为了显示.</p>
<h2 id="检索功能"><a href="#检索功能" class="headerlink" title="检索功能"></a>检索功能</h2><p>检索有多个方式，如关键字检索、分类检索、排序、过滤等。将检索页面需要用到的条件，全部封装成一个对象。</p>
<p>先封装dsl请求检索语句，将语句通过es对象search后，封装其返回数据交予前端。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ES有更新和检索两个功能，更新在商品上架时，由product远程调用，检索则是页面搜索框调用，其url拼接条件进行检索，根据不同情况写全拼接的状态，如关键词搜索，会对检索关键字自行前端标签的拼接，使其在其前端展示时，取出高亮的前端标签字段。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>ES更新操作怎么处理？我们先将商品下架，删除ES，随后上架再更新？</p>
<h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><p>动静分离，nginx分离静态资源和动态资源。修改hosts，配置虚拟机ip映射。使用插件SwitchHosts。</p>
<p>nginx代理网关时，会丢失host等信息。请求发送到nginx，nginx转发到网关进一步分配。</p>
<p>修改host将商城域名映射到linux的ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.56.11 mall.com</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    listen  [::]:80;</span><br><span class="line">    server_name  mall.com *.mall.com;</span><br><span class="line">    </span><br><span class="line">    location /static/ &#123;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_pass http://mall;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upstream mall&#123;</span><br><span class="line">	server 192.168.158.1:3000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析以上配置，访问mall.com以及其子域名，会走nginx，若是静态资源，其后链接会跟static，然后走conf的配置，请求去查看nginx的静态资源。其他的正常连接，则走网关代理，网关的ip我们会在nginx.conf中配置，也就是我们主机的网关ip和端口。而且要设置host值，nginx代理会丢失。</p>
<p>然后我们在网关中进行host映射配置。nginx转发到网关进行代理，会有一开始输入的域名host，这个host则对应网关配置的映射，路由到对应的微服务。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">mall_host_route</span></span><br><span class="line">	<span class="attr">uri:</span> <span class="string">lb://mall-product</span></span><br><span class="line">    <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Host=mall.com,item.mall.com</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">mall_search_route</span></span><br><span class="line">	<span class="attr">uri:</span> <span class="string">lb://mall-search</span></span><br><span class="line">    <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Host=search.mall.com</span></span><br></pre></td></tr></table></figure>



<h2 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h2><p>静态资源放置于nginx，而不是项目。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /static/ &#123;</span><br><span class="line">	root /usr/share/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">	proxy_set_header Host $host;</span><br><span class="line">	proxy_pass http://mall;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置请求路径的分发策略，页面所有静态资源+static前缀，对应nginx来匹配其static路径下的资源，其他的接口url走项目。静态资源由nginx处理，和我们服务器无关。</p>
<p>前端页面有static前缀资源就走nginx内部请求，其他请求走页面请求。</p>
<h1 id="测试与调优"><a href="#测试与调优" class="headerlink" title="测试与调优"></a>测试与调优</h1><p>使用Jmeter压力测试，Jvisualvm操作JVM（jdk自带，直接命令行启动）。通过测试来判断程序性能，进而对数据库和代码进行调优。</p>
<p>代码逻辑应尽少于数据库交互，以此来优化代码。所以需要使用缓存来提高性能。</p>
<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="redis缓存"><a href="#redis缓存" class="headerlink" title="redis缓存"></a>redis缓存</h2><p>设计缓存是为了减少数据库的压力，将部分数据存放到缓存中，比如：</p>
<ul>
<li>高访问量，且更新频率小的数据，多读少写（高频热点数据）</li>
<li>对即时性、数据一致性要求不高的数据</li>
</ul>
<p>我们注入redis的start依赖，使用StringRedisTemplate操纵redis</p>
<p>对即时性、一致性要求高的数据就应该去查数据库，不要求的数据则放入缓存，设置过期时间保证隔段时间获得最新数据。</p>
<h2 id="分布式锁（Redisson）"><a href="#分布式锁（Redisson）" class="headerlink" title="分布式锁（Redisson）"></a>分布式锁（Redisson）</h2><p>保证多服务调用的数据一致性。</p>
<p>官方配置了不同语言的分布式锁实现，Java 对应 Redisson。</p>
<p>Redisson和JUC锁的使用相对应。</p>
<h2 id="SpringCache"><a href="#SpringCache" class="headerlink" title="SpringCache"></a>SpringCache</h2><p>主启动类 + @EnableCaching</p>
<p>方法 + @Cacheable等注解，不同注解效果不同，默认是对注解方法的结果进行缓存操作，若结果存在则不调用方法。</p>
<p>@CacheEvict缓存失效模式</p>
<p>@Caching多个缓存操作进行组合</p>
<p>使用SpringCache是再进行复杂查询操作时使用，将结果进行缓存，若在方法内部想使用缓存可直接操作redisTemplate对象，这个注解只是用于缓存返回值。</p>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><ul>
<li>登录验证码</li>
<li>多次查询的数据，如多级菜单</li>
<li>全局统一存储session</li>
<li>购物车信息</li>
<li>热点数据</li>
</ul>
<h1 id="系统登录"><a href="#系统登录" class="headerlink" title="系统登录"></a>系统登录</h1><h2 id="页面跳转"><a href="#页面跳转" class="headerlink" title="页面跳转"></a>页面跳转</h2><p>以前都是使用controller，进行mapping路径映射返回string走对应页面，现在由于请求路径过多，配置一个config实现WebMvcConfigurer接口，调用addViewControllers添加路径映射。以防controller有太多空请求方法，导致代码冗余。</p>
<h2 id="注册时发送验证码"><a href="#注册时发送验证码" class="headerlink" title="注册时发送验证码"></a>注册时发送验证码</h2><p>验证码有很多种情况，我们一个账户当然可以要很多个验证码，一般过期时间时5min，但间隔请求时间是60s。</p>
<p>由于前端规定验证码获取是60s一次，但可以通过直接接口调用等手段避开前端判断，所以我们需要后端进行逻辑验证。</p>
<p>在生成验证码时，我们是随机数UUID生成，然后可在其后拼接一个系统时间。</p>
<p>当前端请求验证码时，先在缓存中获取当前手机的验证码信息，若验证码信息不为空则继续判断，若其生成时间和当前时间间隔不到60s，则需要等待，返回报错信息，这是后端进行接口层上的逻辑完善。</p>
<p>当然验证码我们拼接了系统时间，可以通过截取字符串来获取前几位的校验字段发给用户，后几位截取记为标记时间。</p>
<h2 id="注册信息校验"><a href="#注册信息校验" class="headerlink" title="注册信息校验"></a>注册信息校验</h2><h2 id="密码"><a href="#密码" class="headerlink" title="密码"></a>密码</h2><p>又是md5 + 盐值。。。</p>
<p>不过有改进，可以使用spring的<code>BCryptPasswordEncoder</code>，不用另行存储盐值，其生成密文通过算法可自行解析盐值，省去了在数据库中进行盐值存储，进一步加强了安全。</p>
<p>同一个密码明文 + 不同盐值生成的不同随机数，经过算法解密后可得到同一个明文，所以同一个密码无影响，算法自身会解析盐值。</p>
<p>而登录进行验证时，调用<code>BCryptPasswordEncoder</code>的<strong>matches方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span></span></span><br></pre></td></tr></table></figure>

<p>参数一是页面输入原密码，参数二是数据库存储加密密码，由于这个加密是该方法自行生成的，所以可自行验证页面原密码的正确性。返回boolean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(CharSequence rawPassword)</span></span></span><br></pre></td></tr></table></figure>

<p>通过调用encode方法对原密码加密。</p>
<h2 id="社交登录-OAuth2-0协议"><a href="#社交登录-OAuth2-0协议" class="headerlink" title="社交登录 OAuth2.0协议"></a>社交登录 OAuth2.0协议</h2><p>系统登录向用户申请第三方请求认证，用户前往第三方服务器进行登录操作，通过验证后，由第三方向系统发送登录令牌，我们系统可通过登录令牌访问第三方服务器获取头像、昵称等公开资源。</p>
<p>使用QQ作为社交登录，自行验证身份并创建应用。</p>
<p><a target="_blank" rel="noopener" href="https://op.open.qq.com/appregv2/">https://op.open.qq.com/appregv2/</a></p>
<p><a target="_blank" rel="noopener" href="https://connect.qq.com/manage.html#/">https://connect.qq.com/manage.html#/</a></p>
<p>可以根据官方api获取一些数据。</p>
<p>。。。。。审核太恶心，不做了。注意社交登录也应将信息注册到系统的数据库。</p>
<h2 id="Session的状态记录"><a href="#Session的状态记录" class="headerlink" title="Session的状态记录"></a>Session的状态记录</h2><p>以前的单体项目可以使用Session，但Session不能跨域名共享。</p>
<p>但现在是微服务的项目，服务是分模块的，不同服务间的Session也是不共享的，集群也是。</p>
<ul>
<li><p>同一个服务，不同机器，也就是同一个服务的集群session共享解决：</p>
<ul>
<li><strong>session复制</strong>，进行集群间机器的session同步，但是同步数据需要数据传输，占用网络资源，且为了保证同步，所有的服务器都要保存，每台服务都要开辟这个session的空间，对于分布式集群很不友好。</li>
<li><strong>客户端存储</strong>，用户自行保存session到cookie，不安全，而且cookie不能存储大量数据。</li>
<li><strong>hash一致性</strong>，根据服务ip，将同一个ip的请求都分配到同一个服务器上，也就是负载均衡是分配不同ip的，同一个ip一直用同一个服务器，但是机器水平扩展会导致hash算法出现问题。</li>
<li><strong>统一存储</strong>，将session不存到服务器，而是redis或其他数据库，没有安全隐患，水平扩展集群不会影响，但缺点是需要多进行一次网络连接数据库，且查询数据库一定比直接的内存查询慢。</li>
</ul>
<p><strong>推荐使用hash一致性 或 数据库统一存储。</strong></p>
</li>
</ul>
<h2 id="SpringSession"><a href="#SpringSession" class="headerlink" title="SpringSession"></a>SpringSession</h2><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-session/docs/2.4.6/reference/html5/#samples">https://docs.spring.io/spring-session/docs/2.4.6/reference/html5/#samples</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml需要指定session的存储数据库，主启动类加上注解@EnableRedisHttpSession，需要修改session的作用域，作用于父域则所有子域都会被辐射到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallSessionConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CookieSerializer <span class="title">cookieSerializer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultCookieSerializer cookieSerializer = <span class="keyword">new</span> DefaultCookieSerializer();</span><br><span class="line">        <span class="comment">// 扩大作用域</span></span><br><span class="line">        cookieSerializer.setDomainName(<span class="string">&quot;mall.com&quot;</span>);</span><br><span class="line">        cookieSerializer.setCookieName(<span class="string">&quot;MALL_SESSION&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> cookieSerializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisSerializer&lt;Object&gt; <span class="title">springSessionDefaultRedisSerializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GenericJackson2JsonRedisSerializer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们每个服务需要用到session时，需要加载pom、config配置类、主启动类注解、yml的配置（redis、session-type）</p>
<ul>
<li>spring-session，yml配置其缓存使用的数据库，我们使用redis</li>
<li>session需要存储的实体类实现序列化Serializable接口，然后在config中自行配置放大作用域，以及redis的json序列化存储。因为我们是用户登录服务进行登录的，是二级域名，需要放大作用域，以便辐射其他服务。</li>
<li>session首次被set是按kv设置的，我们后续从redis取，也是用这个key去拿。</li>
</ul>
<h2 id="单点登录"><a href="#单点登录" class="headerlink" title="单点登录"></a>单点登录</h2><p>多系统间登录互通，比如登录百度账号，所有百度的应用都会自行登录。</p>
<p>我们前面使用session是对子域名来说的，即mall.com是顶级域名，search.mall.com和auth.mall.com都是其子域名。而单点登录是作用于完全不同的几个域名之间的不同1.com、2.com、3.com。</p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/xuxueli0323/xxl-sso?_from=gitee_search">https://gitee.com/xuxueli0323/xxl-sso?_from=gitee_search</a></p>
<p>单点登录一般有一个认证服务器，通过该服务器进行跳转。</p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>在子域名进行注册操作，导致要使用统一存储session，并自定义sesssion扩域的config配置，redis缓存session，让每个域名都来使用session。这个项目用不到单点登录，因为只有一个域名，其余都是其子域名。</p>
<h1 id="购物车（redis-hash存储）"><a href="#购物车（redis-hash存储）" class="headerlink" title="购物车（redis hash存储）"></a>购物车（redis hash存储）</h1><h2 id="存储结构"><a href="#存储结构" class="headerlink" title="存储结构"></a>存储结构</h2><p>购物车缓存使用hash存储，key是固定封装前缀 + 用户id，从session取用户id，value是商品id和商品信息的kv组合，商品信息是远程商品服务调用查询的。</p>
<h2 id="分析概述"><a href="#分析概述" class="headerlink" title="分析概述"></a>分析概述</h2><p>购物车首先分两种情况，登录用户和游客。</p>
<ul>
<li>登录用户：选择redis，由于购物车需要多读写不应使用mysql造成压力，可使用nosql频繁读写。</li>
<li>游客：可以存储到本地的cookie或localstorage，但这些数据我们服务器后端是没有数据的，就无法对用户的喜好进行分析进而推送数据，综合大数据时代的现状，游客数据也会存储到redis。</li>
</ul>
<p>当然大数据是使用redis，减轻mysql的压力，小数据量使用mysql也可以。但是基于现在的商城业务，离线购物车这个应该舍弃，因为连账号都没有的用户，更容易利用这一点存储垃圾数据。</p>
<p>redis存储使用hash结构。</p>
<h2 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h2><p>redis存储购物车，先查session拿id，添加购物车时，若已经拥有则直接修改，没有则新增。</p>
<p>使用ThreadLocal，让service层可以使用session信息，配置到自定义拦截器中，然后将自定义拦截器注入。</p>
<p>添加购物车数据采用异步任务，提高效率。</p>
<p>关于价格，我们封装类就重写了get、set方法，在get、set时会计算值。</p>
<h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><p>把ThreadLocal配置到拦截器中，session存在则存储到threadlocal中，保证当前线程的session共享，后续订单服务也要使用这个。</p>
<h1 id="订单服务"><a href="#订单服务" class="headerlink" title="订单服务"></a>订单服务</h1><h2 id="Service层获取Session"><a href="#Service层获取Session" class="headerlink" title="Service层获取Session"></a>Service层获取Session</h2><p>我们设置mvc拦截器，除了拦截未登录用户外，还可以定义一个ThreadLocal变量，该变量在同一个线程中不会改变，我们可以在拦截器中，通过request获取session，然后将session的值存储到ThreadLocal中，在Service层就可以直接使用ThreadLocal的存储数据即可，解决了service层获取session的问题。</p>
<p>或者注入HttpSession，在Service获取session信息，但拦截器本来就要获取session，可以直接在拦截器里获取。这也为了实战ThreadLocal。</p>
<h2 id="远程调用与session冲突"><a href="#远程调用与session冲突" class="headerlink" title="远程调用与session冲突"></a>远程调用与session冲突</h2><p>场景：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">我们确认订单信息，远程调用服务，首先使用用户服务获取用户地址，我们这个远程服务传入了该线程中的session相关数据，成功调用。</span><br><span class="line">然后我们要获取所有购物车的内容，调用购物车远程服务，但是购物车这个远程服务无需参数，当时写功能时，就是让它通过当前拦截器ThreadLocal拿Session数据进行处理的。结果这里远程调用出现的了问题，ThreadLocal拿不到数据。</span><br></pre></td></tr></table></figure>

<p>原因是<strong>feign远程调用会丢失请求头信息</strong>，它会创建一个新请求去访问远端服务，但原请求的请求头信息就没有了。这时远程购物车服务会判断我们没有登录，所以拿不到session，ThreadLocal肯定拿不到值。</p>
<p><strong>解决办法：添加一个feign调用的请求拦截器，将原请求Cookie信息存储到新的远程调用请求。配置RequestInterceptor这个拦截器。</strong></p>
<p>因为feign处理远程服务使用的是一个初始化的拦截器，我们对这个拦截器进行配置，可将原请求的cookie封装到新请求。防止Cookie信息丢失。</p>
<h2 id="异步任务与feign调用冲突"><a href="#异步任务与feign调用冲突" class="headerlink" title="异步任务与feign调用冲突"></a>异步任务与feign调用冲突</h2><p>ThreadLocal只能同一个线程中变量共享。</p>
<p>我们使用CompletableFuture异步任务加快服务操作的效率，但信息不能共享，我们可以在主线程获取上下文信息，然后在子线程执行操作时先将上下文信息保存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RequestContextHolder.setRequestAttributes(requestAttributes);</span><br></pre></td></tr></table></figure>

<h2 id="接口幂等性问题"><a href="#接口幂等性问题" class="headerlink" title="接口幂等性问题"></a>接口幂等性问题</h2><p>对于提交订单这个操作，用户市不能对一个订单进行多次提交操作的，也就是幂等性问题。</p>
<p>幂等性即多次请求结果一致，多次接口请求只提交一次订单。一些场景如下：</p>
<ul>
<li>用户多次操作</li>
<li>页面回退后返回再次提交</li>
<li>微服务间的调用，如库存克扣问题。</li>
</ul>
<p>解决方法有：</p>
<ul>
<li>数据库设计唯一，标记唯一标识，如数据库唯一索引</li>
<li>携带token，令牌机制，其令牌操作要保证原子性，redis存储token可使用lua进行辅助</li>
<li>悲观锁、乐观锁</li>
<li>分布式锁</li>
<li>携带全局的唯一id</li>
</ul>
<h2 id="Token令牌防重"><a href="#Token令牌防重" class="headerlink" title="Token令牌防重"></a>Token令牌防重</h2><p>redis存储令牌，使用string结构，k是用户id，v是uuid生成的token，并设置30min过期时间。后续提交订单要通过token进行防重操作。</p>
<p>在购物车确认并生成订单，封装订单信息时，会生成一个防重令牌并缓存到redis（token是string结构，反复确认订单会把上次的token覆盖），然后controller会将封装信息设置到model中并跳转到订单提交页，提交订单去结算时，会使用lua脚本比对缓存与订单信息的token，比对通过就删除token，并创建订单、锁库存，然后通过mq进行解锁判定处理。订单创建完后将购物车session信息删除。</p>
<p>使用lua脚本是为了保证令牌的获取、比较、删除三个操作的原子性，防止多次请求同时完成操作，导致订单重复创建。</p>
<h2 id="提交订单"><a href="#提交订单" class="headerlink" title="提交订单"></a>提交订单</h2><p>直接去购物车获取信息，而不是提交页面，因为用户可能提前打开提交页面，然后再去购物车操作数据，所以直接去购物车拿数据即可。</p>
<p>提交订单后，可以分成以下操作。</p>
<ul>
<li><p>下单</p>
</li>
<li><p>创建订单</p>
</li>
<li><p>验证令牌并删除</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> </span><br><span class="line">    redis.call(<span class="string">&#x27;get&#x27;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] </span><br><span class="line">    <span class="keyword">then</span> <span class="keyword">return</span> redis.call(<span class="string">&#x27;del&#x27;</span>, KEYS[<span class="number">1</span>]) <span class="keyword">else</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>使用lua脚本保证令牌验证与删除操作的原子性。</p>
<p>令牌即用即删，防止其他订单使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String orderToken = vo.getOrderToken();</span><br><span class="line">Long result = stringRedisTemplate.execute(</span><br><span class="line">        <span class="keyword">new</span> DefaultRedisScript&lt;Long&gt;(script, Long.class),</span><br><span class="line">        Arrays.asList(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberResponseVo.getId()),</span><br><span class="line">        orderToken</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这里script即上述脚本，我们在购物车确认订单界面，会在redis存储token，kv示例上面说过，然后在提交订单到支付界面进行token二次确认。获取当前订单id，从redis取token并与当前订单自身携带的token进行对比，二者相同说明是同一个订单未被消费，然后去付款。校验后马上删除redis的token，确保订单不会被重复创建。</p>
</li>
<li><p>验证价格</p>
<p>将页面价格与购物车价格计算后校验。</p>
</li>
<li><p>锁库存</p>
<p>先锁在卖，订单远程调用库存服务的方法，使用事务。</p>
<p>由于存在远程服务调用，对于锁库存涉及到分布式事务。</p>
</li>
</ul>
<p><strong>首先整个订单提交服务是一个本地事务，有多次校验，令牌校验、价格校验（订单总额与购物车总额对比，防止用户在订单页去修改购物车）、库存校验，一次校验失败就会返回对应报错信息，并执行回滚操作；而其远程调用库存涉及分布式事务，采用MQ实现最终一致性来解决</strong></p>
<h2 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h2><p>由于我们服务会远程调用服务，如a、b两次远程调用，a成功，b失败，但b失败只会导致b服务与当前服务回滚，a服务因为远程调用并通过，后续回滚它却不会接收到信息。</p>
<p>在分布式项目中，我们可能服务嵌套调用，以往的本地事务就不在适用，所以我们需要使用分布式事务。</p>
<p>库存回滚使用分布式事务。CAP性质保证AP，即可用性，一致性不用特别强制。</p>
<p>可以使用微服务组件seata解决分布式事务。</p>
<h2 id="seata"><a href="#seata" class="headerlink" title="seata"></a>seata</h2><p>首先数据库中每个微服务需要创建undo_log回滚日志记录表，这是官方规定的。然后启动seata服务器。</p>
<p>在需要的类上添加<code>@GlobalTransactional</code>开启全局事务。</p>
<p>而对于需要使用分布式事务的微服务，需要由seata代理其数据源。</p>
<p>分布式事务主入口标明全局事务，其他的远端调用仍使用本地事务注解即可。</p>
<h2 id="消息队列最终一致性"><a href="#消息队列最终一致性" class="headerlink" title="消息队列最终一致性"></a>消息队列最终一致性</h2><p>定时任务，订单超时关闭订单，而下单的时候会锁定库存，库存设置定时任务，若一定时间后订单不存在，则相应的库存自行解锁。但定时任务资源开销大，不建议使用。</p>
<p>延迟队列，订单创建后进行锁库存，锁库存存入延迟队列，过期后交予解锁库存服务，此时解库存再去看订单是否存在进而判断是否解库存。采用主题模式，消息进来按照路由键走死信，过期后设置路由键走解库存队列。</p>
<p>延迟队列相比于定时任务，优点在于其处理一定在当前订单过期时间之后，定时任务则不稳定。</p>
<h2 id="库存解锁！！！"><a href="#库存解锁！！！" class="headerlink" title="库存解锁！！！"></a>库存解锁！！！</h2><p>柔性事务，最终一致性：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d70df89665b9">https://www.jianshu.com/p/d70df89665b9</a></p>
<p>mq使用时选择手动应答ack。只有死信队列转发后的订单表信息，其订单不存在或订单取消支付，此时将会解库存。手动ack模式，我们可以确保业务执行完毕在应答队列。</p>
<p>由死信转发到解库存的消息，若当前机器服务出现异常或宕机，则将消息重新放入队列，等待下一次的消费。直到消息全部消费。</p>
<p>取消订单后主动发消息给解库存MQ。</p>
<p>一开始设置订单支付等待1min，库存解锁等待2min，解库存mq收到消息时，订单状态肯定从新建变为了支付或取消，这是正常状态，但如果我们遇到网络问题，导致订单支付在解库存后才响应，解库存判断状态是新建则不会有动作，所以为了保底，我们取消订单时要去通知解库存mq，以防上述情况发生，当然支付成功就不用通知。</p>
<p>消息的手动接收和业务处理都是写在try-catch中，捕获异常就拒收消息并将其重入队。</p>
<h2 id="消息确认、重复"><a href="#消息确认、重复" class="headerlink" title="消息确认、重复"></a>消息确认、重复</h2><p>队列和交换机一定是开启持久化，保存到磁盘上。</p>
<p>保证手动ack，业务执行无误再进行消息确认，关闭自动ack。</p>
<p>由于服务器宕机等因素，业务完成后没有及时应答，导致消息重回队列进行消费，我们可以再业务相关处理中设置状态，比方说上述订单解库存，只处理被取消的订单和不存在的订单，且解库存时只处理被锁定的库存，已解锁过的当然不用二次处理了。保证业务的幂等性。</p>
<h2 id="支付宝沙箱模拟支付"><a href="#支付宝沙箱模拟支付" class="headerlink" title="支付宝沙箱模拟支付"></a>支付宝沙箱模拟支付</h2><p>调用官方sdk，引用方法即可支付选择支付宝，成功后跳转回我们的结算页面。还可以配置支付宝提供的自动收单，因为订单会在规定时间内失效，如果等到订单失效后再支付，我们库存都回滚了，但支付成功订单仍变为了已付款，这样肯定是逻辑问题，所以我们配置自动收单，保证付款窗口的有效期不超过订单过期区间。保证订单过期后不能付款。</p>
<h1 id="秒杀"><a href="#秒杀" class="headerlink" title="秒杀"></a>秒杀</h1><ul>
<li><p>定时任务，库存预热</p>
<p>秒杀商品上架使用定时任务，执行异步编排。采用cron表达式 + 注解完成定时任务。</p>
<p><code>@EnableScheduling</code>：定时调度，<code>@EnableAsync</code>：异步任务</p>
<p>或者直接执行异步任务。</p>
<p>定时上架，选择流量较小的深夜错峰上架。提前3天扫描秒杀活动场次，提前将数据缓存到redis</p>
</li>
<li><p>时间处理</p>
<p>使用java8新增的时间处理类，LocalTime，LocalDate，获取当天准确日期、时间，完成秒杀获取3天商品的时间需求。</p>
</li>
<li><p>秒杀加密</p>
<p>携带随机码，获取秒杀商品数据时，会进行时间校验，只有到时了才会给当前商品添加随机码，也就是秒杀生效，其余时间还是正常价。</p>
</li>
<li><p>动静分离</p>
<p>只让后端承受动态请求，降低静态请求带来的压力。</p>
</li>
<li><p><strong>信号量限流</strong></p>
<p>信号量即redis库存，靠这个保证库存</p>
<p>设置Redisson信号量</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43931625/article/details/103232670">https://blog.csdn.net/weixin_43931625/article/details/103232670</a></p>
</li>
<li><p>流量错峰</p>
<p>验证码过滤，不是即点即用。加入购物车</p>
</li>
<li><p>限流、熔断、降级 sentinel</p>
<p>页面降级，点击频率过高就挂掉</p>
</li>
<li><p>队列消峰</p>
<p>信号量再redis，扣减是原子性操作</p>
</li>
</ul>
<h2 id="库存"><a href="#库存" class="headerlink" title="库存"></a>库存</h2><p>库存在上架前提前扣减了，活动结束后再根据失效订单进行解锁，上架库存就以信号量保存到redis中，通过redisson分布式锁完成原子性扣减，保证不会超卖，信号量用完即止。</p>
<h2 id="秒杀设计"><a href="#秒杀设计" class="headerlink" title="秒杀设计"></a>秒杀设计</h2><p>设置秒杀限制数，限制商品的抢购件数。</p>
<p>上架时会设置商品随机码，在主页<strong>进入商品页</strong>时，会先判断当前商品是否秒杀，如果秒杀，在判断当前是否处于秒杀时间段（封装了起始时间），<strong>不存在时间段就将随机码至null</strong>，然后传到前端，商品的封装包括了秒杀信息。在<strong>秒杀商品页面进行秒杀click时</strong>，会传入当前商品的秒杀信息，包括秒杀商品id、秒杀商品的随机码、秒杀数量，然后进行请求，秒杀时进行校验，通过秒杀id获取缓存中的对应商品，校验页面随机码和缓存是否相等，若当前商品不是在秒杀时间内进入则随机码为null，无法通过校验。</p>
<h2 id="熔断降级"><a href="#熔断降级" class="headerlink" title="熔断降级"></a>熔断降级</h2><p>熔断：多服务相互调用，某个服务的调用失败比例超过设定值，或调用失败频率超过设定值。则将异常服务停止，但后续会根据策略对该服务测试，若该服务调用比例恢复到正常值，则重新启用服务。</p>
<p>降级：对某个方法、接口采用兜底方法，即某个方法、接口请求频率达到一定次数就返回兜底方法进行处理，防止大量请求进行访问。</p>
<h1 id="面试mark"><a href="#面试mark" class="headerlink" title="面试mark"></a>面试mark</h1><ul>
<li><p>如何保证缓存与数据库的双写一致性？</p>
<p>双写（mysql修改后修改redis）</p>
<p>失效（mysql修改后删除redis缓存）</p>
<p><strong>对于购物车缓存情况如何处理</strong></p>
</li>
<li><p>Java设计缓存（Map本地缓存）</p>
<p>和单例模式的双重锁定类似。</p>
<p>对于分布式微服务，不能使用，因为本地缓存时相互隔离的，服务每次负载均衡到其他服务器还要重新加载缓存。且多个服务器间还有数据一致性的问题。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u010452388/article/details/82725299">https://blog.csdn.net/u010452388/article/details/82725299</a></p>
</li>
<li><p>点赞功能设计</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liuyupen/p/14015407.html">https://www.cnblogs.com/liuyupen/p/14015407.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhangshengrong.com/p/281oD6Yawz/">https://www.zhangshengrong.com/p/281oD6Yawz/</a></p>
</li>
<li><p>账号重复登录问题</p>
<p>建立在线活跃用户表</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_38295272/article/details/117964982">https://blog.csdn.net/weixin_38295272/article/details/117964982</a></p>
<p>登录存储客户端ip，若多次登录ip不同，说明是不同ip登录，提醒上次登录用户。可以kv存redis，k是用户id，v是客户端ip。还要设置过期时间，如果正常下线，会发请求删除，非正常下线自动过期。一直在线会自动续期。也就是活跃操作续期。</p>
<p>文章中用token，这个可能会受浏览器影响，我们可使用用户的ip。</p>
</li>
<li><p>幂等性</p>
</li>
<li><p>rabbitmq怎么保证消息可靠：开启队列、交换机的持久化，开启手动ack模式。</p>
<p>发生时消息丢失、发送后消息丢失：保证双端确认，消费者手动ack，出现异常拒收消息将消息重入队。</p>
<p>消息重复：业务逻辑避免，如我们解库存业务，消息来了，要解库存，会判断商品库存，只处理锁定状态的商品。</p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://aidianfirst.com">aidianfirst</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://aidianfirst.com/2021/11/23/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">http://aidianfirst.com/2021/11/23/%E5%90%8E%E7%AB%AF/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://aidianfirst.com" target="_blank">哀殿firstの空间</a>！</span></div></div><div class="tag_share"><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/aidianfirst/image/aidian6.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/12/07/%E5%85%AB%E8%82%A1/Spring%E6%A1%86%E6%9E%B6%E5%85%AB%E8%82%A1/" title="Spring框架八股"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/aidianfirst/image/aidian6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring框架八股</div></div></a></div><div class="next-post pull-right"><a href="/2021/10/07/%E5%85%AB%E8%82%A1/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%85%AB%E8%82%A1/" title="设计模式八股"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/aidianfirst/image/aidian6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">设计模式八股</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/aidianfirst/image/aidian.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">aidianfirst</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://space.bilibili.com/29529786"><i></i><span>BiliBili空间</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/aidianfirst" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=1262306856&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">虚拟机环境配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%8F%8D%E5%90%91%E5%B7%A5%E7%A8%8B%E8%BE%85%E5%8A%A9crud"><span class="toc-number">2.</span> <span class="toc-text">快速反向工程辅助crud</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">商品服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8F%9C%E5%8D%95%E5%88%86%E7%BA%A7%E5%B1%95%E7%A4%BA"><span class="toc-number">3.1.</span> <span class="toc-text">菜单分级展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%EF%BC%88%E8%B7%A8%E5%9F%9F%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">网关（跨域）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CRUD"><span class="toc-number">3.3.</span> <span class="toc-text">CRUD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSR303"><span class="toc-number">3.4.</span> <span class="toc-text">JSR303</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84"><span class="toc-number">3.5.</span> <span class="toc-text">属性分组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E5%88%86%E7%B1%BB"><span class="toc-number">3.6.</span> <span class="toc-text">关联分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VO"><span class="toc-number">3.7.</span> <span class="toc-text">VO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%95%86%E5%93%81Vo"><span class="toc-number">3.8.</span> <span class="toc-text">生成商品Vo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transactional"><span class="toc-number">3.9.</span> <span class="toc-text">@Transactional</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#feign%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-number">3.10.</span> <span class="toc-text">feign服务调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85"><span class="toc-number">3.11.</span> <span class="toc-text">商品详情</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.</span> <span class="toc-text">阿里云第三方服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1%E4%BA%91%E5%AD%98%E5%82%A8OSS"><span class="toc-number">4.1.</span> <span class="toc-text">第三方服务云存储OSS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">4.2.</span> <span class="toc-text">短信验证码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Elasticsearch%EF%BC%887-6-2%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">Elasticsearch（7.6.2）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6"><span class="toc-number">5.1.</span> <span class="toc-text">商品上架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E5%8A%9F%E8%83%BD"><span class="toc-number">5.2.</span> <span class="toc-text">检索功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.3.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">5.4.</span> <span class="toc-text">思考</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx"><span class="toc-number">6.</span> <span class="toc-text">Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">6.1.</span> <span class="toc-text">动静分离</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%B8%8E%E8%B0%83%E4%BC%98"><span class="toc-number">7.</span> <span class="toc-text">测试与调优</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis"><span class="toc-number">8.</span> <span class="toc-text">Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E7%BC%93%E5%AD%98"><span class="toc-number">8.1.</span> <span class="toc-text">redis缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%EF%BC%88Redisson%EF%BC%89"><span class="toc-number">8.2.</span> <span class="toc-text">分布式锁（Redisson）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCache"><span class="toc-number">8.3.</span> <span class="toc-text">SpringCache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF"><span class="toc-number">8.4.</span> <span class="toc-text">场景</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%99%BB%E5%BD%95"><span class="toc-number">9.</span> <span class="toc-text">系统登录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC"><span class="toc-number">9.1.</span> <span class="toc-text">页面跳转</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%97%B6%E5%8F%91%E9%80%81%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">9.2.</span> <span class="toc-text">注册时发送验证码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%BF%A1%E6%81%AF%E6%A0%A1%E9%AA%8C"><span class="toc-number">9.3.</span> <span class="toc-text">注册信息校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E7%A0%81"><span class="toc-number">9.4.</span> <span class="toc-text">密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BE%E4%BA%A4%E7%99%BB%E5%BD%95-OAuth2-0%E5%8D%8F%E8%AE%AE"><span class="toc-number">9.5.</span> <span class="toc-text">社交登录 OAuth2.0协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session%E7%9A%84%E7%8A%B6%E6%80%81%E8%AE%B0%E5%BD%95"><span class="toc-number">9.6.</span> <span class="toc-text">Session的状态记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringSession"><span class="toc-number">9.7.</span> <span class="toc-text">SpringSession</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95"><span class="toc-number">9.8.</span> <span class="toc-text">单点登录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">9.9.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B4%AD%E7%89%A9%E8%BD%A6%EF%BC%88redis-hash%E5%AD%98%E5%82%A8%EF%BC%89"><span class="toc-number">10.</span> <span class="toc-text">购物车（redis hash存储）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="toc-number">10.1.</span> <span class="toc-text">存储结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%A6%82%E8%BF%B0"><span class="toc-number">10.2.</span> <span class="toc-text">分析概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%86%E8%8A%82"><span class="toc-number">10.3.</span> <span class="toc-text">细节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocal"><span class="toc-number">10.4.</span> <span class="toc-text">ThreadLocal</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1"><span class="toc-number">11.</span> <span class="toc-text">订单服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Service%E5%B1%82%E8%8E%B7%E5%8F%96Session"><span class="toc-number">11.1.</span> <span class="toc-text">Service层获取Session</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E4%B8%8Esession%E5%86%B2%E7%AA%81"><span class="toc-number">11.2.</span> <span class="toc-text">远程调用与session冲突</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E4%B8%8Efeign%E8%B0%83%E7%94%A8%E5%86%B2%E7%AA%81"><span class="toc-number">11.3.</span> <span class="toc-text">异步任务与feign调用冲突</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">11.4.</span> <span class="toc-text">接口幂等性问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Token%E4%BB%A4%E7%89%8C%E9%98%B2%E9%87%8D"><span class="toc-number">11.5.</span> <span class="toc-text">Token令牌防重</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E8%AE%A2%E5%8D%95"><span class="toc-number">11.6.</span> <span class="toc-text">提交订单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">11.7.</span> <span class="toc-text">分布式事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#seata"><span class="toc-number">11.8.</span> <span class="toc-text">seata</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">11.9.</span> <span class="toc-text">消息队列最终一致性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%93%E5%AD%98%E8%A7%A3%E9%94%81%EF%BC%81%EF%BC%81%EF%BC%81"><span class="toc-number">11.10.</span> <span class="toc-text">库存解锁！！！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E3%80%81%E9%87%8D%E5%A4%8D"><span class="toc-number">11.11.</span> <span class="toc-text">消息确认、重复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E6%A8%A1%E6%8B%9F%E6%94%AF%E4%BB%98"><span class="toc-number">11.12.</span> <span class="toc-text">支付宝沙箱模拟支付</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A7%92%E6%9D%80"><span class="toc-number">12.</span> <span class="toc-text">秒杀</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%93%E5%AD%98"><span class="toc-number">12.1.</span> <span class="toc-text">库存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E8%AE%BE%E8%AE%A1"><span class="toc-number">12.2.</span> <span class="toc-text">秒杀设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-number">12.3.</span> <span class="toc-text">熔断降级</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95mark"><span class="toc-number">13.</span> <span class="toc-text">面试mark</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/12/08/%E5%B7%A5%E4%BD%9C%20&amp;%20%E6%BA%90%E7%A0%81/Spring/" title="Spring"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/aidianfirst/image/conan5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring"/></a><div class="content"><a class="title" href="/2023/12/08/%E5%B7%A5%E4%BD%9C%20&amp;%20%E6%BA%90%E7%A0%81/Spring/" title="Spring">Spring</a><time datetime="2023-12-08T09:33:35.781Z" title="发表于 2023-12-08 17:33:35">2023-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/30/%E5%B7%A5%E4%BD%9C%20&amp;%20%E6%BA%90%E7%A0%81/%E6%95%A3%E8%A3%85%E7%9F%A5%E8%AF%86%E7%82%B9/" title="散装知识点"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/aidianfirst/image/miku4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="散装知识点"/></a><div class="content"><a class="title" href="/2023/07/30/%E5%B7%A5%E4%BD%9C%20&amp;%20%E6%BA%90%E7%A0%81/%E6%95%A3%E8%A3%85%E7%9F%A5%E8%AF%86%E7%82%B9/" title="散装知识点">散装知识点</a><time datetime="2023-07-30T11:20:17.737Z" title="发表于 2023-07-30 19:20:17">2023-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/30/%E5%B7%A5%E4%BD%9C%20&amp;%20%E6%BA%90%E7%A0%81/Controller%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF%E6%B5%85%E6%9E%90/" title="Controller接口调用链路浅析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/aidianfirst/image/yuanchuang2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Controller接口调用链路浅析"/></a><div class="content"><a class="title" href="/2023/07/30/%E5%B7%A5%E4%BD%9C%20&amp;%20%E6%BA%90%E7%A0%81/Controller%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF%E6%B5%85%E6%9E%90/" title="Controller接口调用链路浅析">Controller接口调用链路浅析</a><time datetime="2023-07-30T11:20:17.736Z" title="发表于 2023-07-30 19:20:17">2023-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/30/%E5%B7%A5%E4%BD%9C%20&amp;%20%E6%BA%90%E7%A0%81/Spel%E5%AD%97%E6%AE%B5%E8%A7%A3%E6%9E%90%E6%BA%90%E7%A0%81/" title="Spel字段解析功能源码浅析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/aidianfirst/image/aidian6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spel字段解析功能源码浅析"/></a><div class="content"><a class="title" href="/2023/07/30/%E5%B7%A5%E4%BD%9C%20&amp;%20%E6%BA%90%E7%A0%81/Spel%E5%AD%97%E6%AE%B5%E8%A7%A3%E6%9E%90%E6%BA%90%E7%A0%81/" title="Spel字段解析功能源码浅析">Spel字段解析功能源码浅析</a><time datetime="2023-07-30T11:20:17.736Z" title="发表于 2023-07-30 19:20:17">2023-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/30/%E5%B7%A5%E4%BD%9C%20&amp;%20%E6%BA%90%E7%A0%81/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E9%98%85%E8%AF%BB%E5%AD%A6%E4%B9%A0/" title="并发编程实战阅读学习"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/aidianfirst/image/yuanchuang2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="并发编程实战阅读学习"/></a><div class="content"><a class="title" href="/2023/07/30/%E5%B7%A5%E4%BD%9C%20&amp;%20%E6%BA%90%E7%A0%81/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E9%98%85%E8%AF%BB%E5%AD%A6%E4%B9%A0/" title="并发编程实战阅读学习">并发编程实战阅读学习</a><time datetime="2023-07-30T11:20:17.736Z" title="发表于 2023-07-30 19:20:17">2023-07-30</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/aidianfirst/image/aidian6.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By aidianfirst</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>function loadWaline () {
  function initWaline () {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://aidianfirst-blog.vercel.app',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))
  }

  if (typeof Waline === 'object') initWaline()
  else {
    getCSS('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.css').then(() => {
      getScript('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.js').then(initWaline)
    })
  }
}

if ('Waline' === 'Waline' || !false) {
  if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><div class="aplayer no-destroy" data-id="2532053828" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="true" muted> </div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","hOffset":50,"vOffset":-50,"width":150,"height":350},"mobile":{"show":false},"log":false});</script></body></html>